<!doctype html>
<html lang="en">
    <head>
        <title>SSE Demo</title>
    </head>
    <body>
        <h1>来自服务器的实时消息</h1>
        <div id="message"></div>

        <button id="start">Start</button>
        <script>
            // 1. 创建 EventSource 实例，指向我们的后端端点
            // const eventSource = new EventSource("http://localhost:3000/events");

            // // 2. 监听 message 事件
            // eventSource.onmessage = (event) => {
            //     // event.data 就是服务器发送过来的数据
            //     document.getElementById("message").innerText += event.data;
            // };

            // // 3. (可选) 监听错误
            // eventSource.onerror = (err) => {
            //     console.error("EventSource failed:", err);
            // };
        </script>
        <script>

        function parseData(data) {
          // 解析数据 data: 开头，换行符结尾
          if (data.startsWith("data:")) {
            return {
              data: data.replace("data:", "").trim()
            }
          }
          if (data.startsWith("event:")) {
            return {
              event: data.replace("event:", "").trim()
            }
          }
          return data;
        }

          function fetchStream() {

            const url = "http://localhost:3000/events";

            fetch(url)
              .then(async response => {
                console.log(response);
                const reader = response.body.getReader();

                while (true) {
                  const {value, done} = await reader.read();
                  if (done) {
                    break;
                  }
                  console.log(value);
                  const data = new TextDecoder().decode(value);
                  console.log(data);
                  console.log(parseData(data));
                  const parsedData = parseData(data);
                  document.getElementById("message").innerText += parsedData.data || "";
                }

              })
              .catch(error => {
                console.error('Error:', error);
              });
          }

          const startButton = document.getElementById("start");
          startButton.addEventListener("click", fetchStream);
        </script>
    </body>
</html>
